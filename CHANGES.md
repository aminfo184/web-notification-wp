# تغییرات انجام شده در سیستم ارسال نوتیفیکیشن

## خلاصه تغییرات

### 1. ایجاد سیستم پردازش جدید (`background-processor.php`)
- **جایگزین سیستم wp-cron** با یک سیستم مستقل
- **پردازش پس‌زمینه** با استفاده از AJAX و درخواست‌های غیر مسدودکننده
- **کنترل دقیق بر تعداد ارسال** در هر دقیقه (batch_size)
- **مدیریت وضعیت** شروع/توقف پردازش از طریق ادمین
- **شروع خودکار** در صورت وجود آیتم‌های در انتظار

### 2. بهبود API Routes (`api-routes.php`)
- **3 endpoint جدید**:
  - `POST /wp-json/wnw/v1/send/user` - ارسال به کاربر مشخص
  - `POST /wp-json/wnw/v1/send/users` - ارسال به لیست کاربران
  - `POST /wp-json/wnw/v1/send/custom` - ارسال با محتوای سفارشی
- **ارسال فوری بدون صف** برای استفاده از API
- **انعطاف‌پذیری** در استفاده از template یا محتوای دلخواه

### 3. به‌روزرسانی Dashboard (`dashboard-template.php`)
- **کنترل‌های جدید** برای مدیریت سیستم ارسال
- **آمار کامل** از وضعیت صف و نوتیفیکیشن‌ها
- **به‌روزرسانی زنده** وضعیت هر 30 ثانیه
- **تنظیمات سریع** batch_size
- **راهنمای API** و رفع مشکل

### 4. حفظ سازگاری (`cron-handler.php`)
- **نگه‌داری سیستم قدیمی** به عنوان fallback
- **ترکیب هوشمند** سیستم جدید و قدیمی
- **تابع کمکی** `wnw_add_to_queue` برای اضافه کردن به صف

### 5. به‌روزرسانی فایل اصلی (`web-notification-wp.php`)
- **غیرفعال کردن wp-cron قدیمی**
- **بارگذاری فایل جدید background-processor**
- **پاکسازی cron jobs** در هنگام غیرفعال‌سازی

## مزایای سیستم جدید

1. **عملکرد بهتر**: عدم وابستگی به wp-cron که ممکن است کار نکند
2. **کنترل دقیق‌تر**: امکان شروع/توقف دستی پردازش
3. **ارسال سریع‌تر**: سیستم پردازش پس‌زمینه مستقل
4. **API قدرتمند**: امکان ارسال فوری از طریق API
5. **مانیتورینگ بهتر**: نمایش وضعیت زنده در dashboard
6. **مقیاس‌پذیری**: تنظیم تعداد ارسال در هر دقیقه

## نحوه استفاده

### از طریق Dashboard
1. به صفحه داشبورد پلاگین بروید
2. از بخش "کنترل سیستم ارسال" پردازش را شروع کنید
3. تعداد ارسال در هر دقیقه را تنظیم کنید
4. آمار زنده را مشاهده کنید

### از طریق API

#### ارسال به کاربر مشخص:
```bash
curl -X POST "http://yoursite.com/wp-json/wnw/v1/send/user" \
-H "Content-Type: application/json" \
-d '{
  "user_id": 1,
  "title": "عنوان نوتیف",
  "message": "متن پیام",
  "url": "https://example.com"
}'
```

#### ارسال به همه کاربران:
```bash
curl -X POST "http://yoursite.com/wp-json/wnw/v1/send/custom" \
-H "Content-Type: application/json" \
-d '{
  "title": "اطلاعیه عمومی",
  "message": "این پیام برای همه کاربران ارسال می‌شود",
  "user_ids": "all"
}'
```

## نکات مهم

1. **بررسی کلیدهای VAPID**: مطمئن شوید که در تنظیمات پلاگین کلیدهای VAPID تنظیم شده‌اند
2. **مجوز مرورگر**: کاربران باید اجازه نمایش نوتیفیکیشن را به سایت داده باشند
3. **Service Worker**: فایل service-worker.js باید قابل دسترسی باشد
4. **بروزرسانی تدریجی**: سیستم به صورت خودکار از cron قدیمی به سیستم جدید مهاجرت می‌کند

## رفع مشکل

اگر نوتیفیکیشن‌ها ارسال نمی‌شوند:
1. کلیدهای VAPID را در تنظیمات بررسی کنید
2. سیستم ارسال را متوقف و مجدداً شروع کنید
3. در کنسول مرورگر خطاهای JavaScript را بررسی کنید
4. مطمئن شوید که URL service worker درست است

## پشتیبانی

در صورت بروز مشکل، سیستم به صورت خودکار به روش قدیمی (wp-cron) بازگشت می‌کند تا عملکرد پلاگین مختل نشود.